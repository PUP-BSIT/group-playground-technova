<div class="view-container">
  <h1 class="page-title">Manage Request</h1>
  
  <div class="filter-section">
    <div class="search-box">
      <input type="text" placeholder="Search by requester, item, or ID..." [(ngModel)]="searchText">
      <button class="search-button">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
          <circle cx="11" cy="11" r="8"/>
          <path d="m21 21-4.35-4.35"/>
        </svg>
      </button>
    </div>
    <div class="filter-dropdowns">
      <select class="filter-dropdown" [(ngModel)]="selectedType">
        <option>All Types</option>
        <option>Equipment</option>
        <option>Facility</option>
      </select>
      <select class="filter-dropdown" [(ngModel)]="selectedStatus">
        <option>All Status</option>
        <option>Pending</option>
        <option>Approved</option>
        <option>Rejected</option>
      </select>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading && allRequests.length === 0" class="loading-message">
    Loading requests...
  </div>

  <!-- Error State -->
  <div *ngIf="error" class="error-message">
    {{ error }}
    <button *ngIf="allRequests.length === 0" (click)="loadAllRequests()" class="retry-button">Retry</button>
  </div>

  <!-- Success State -->
  <div *ngIf="successMessage" class="success-message">
    {{ successMessage }}
  </div>

  <!-- Requests List -->
  <div class="requests-list" *ngIf="!loading || allRequests.length > 0">
    @if (filteredRequests.length === 0 && !loading) {
      <div class="no-requests">
        <p>No requests found matching your criteria.</p>
      </div>
    }
    
    @for (request of filteredRequests; track request.id) {
      <div class="request-card">
        <div class="request-card-header">
          <div>
            <span class="request-id">R{{ request.id }}</span>
            <span [class]="'status-badge ' + getStatusClass(request.status)">
              {{ request.status | titlecase }}
            </span>
          </div>
          <div class="request-actions">
            @if (request.status === 'pending') {
              <button 
                class="approve-button" 
                (click)="approveRequest(request)"
                [disabled]="actionLoading">
                Approve
              </button>
              <button 
                class="decline-button" 
                (click)="declineRequest(request)"
                [disabled]="actionLoading">
                Decline
              </button>
            } @else {
              <span class="action-status-label" [ngClass]="getStatusClass(request.status)">
                {{ request.status | titlecase }}
              </span>
            }
          </div>
        </div>
        <h3 class="request-title">{{ request.name }}</h3>
        <div class="request-details-grid">
          <div class="detail-item">
            <span class="detail-label">Requester:</span>
            <span class="detail-value">{{ request.requester }}</span>
          </div>
          @if (request.dateTime) {
            <div class="detail-item">
              <span class="detail-label">Date & Time:</span>
              <span class="detail-value">{{ request.dateTime }}</span>
            </div>
          }
          @if (request.borrowDate) {
            <div class="detail-item">
              <span class="detail-label">Borrow Date:</span>
              <span class="detail-value">{{ formatDate(request.borrowDate) }}</span>
            </div>
          }
          @if (request.returnDate || request.expectedReturnDate) {
            <div class="detail-item">
              <span class="detail-label">{{ request.type === 'equipment' ? 'Expected Return:' : 'Return:' }}</span>
              <span class="detail-value">{{ formatDate(request.returnDate || request.expectedReturnDate || '') }}</span>
            </div>
          }
        </div>
        <div class="request-details-grid">
          @if (request.quantity) {
            <div class="detail-item">
              <span class="detail-label">Quantity:</span>
              <span class="detail-value">{{ request.quantity }}</span>
            </div>
          }
          <div class="detail-item">
            <span class="detail-label">Requested:</span>
            <span class="detail-value">{{ formatDate(request.createdAt) }}</span>
          </div>
        </div>
        @if (request.purpose) {
          <div class="detail-item">
            <span class="detail-label">Purpose:</span>
            <span class="detail-value">{{ request.purpose }}</span>
          </div>
        }
        @if (request.adminNotes) {
          <div class="detail-item">
            <span class="detail-label">Admin Notes:</span>
            <span class="detail-value">{{ request.adminNotes }}</span>
          </div>
        }
      </div>
    }
  </div>
</div>

<!-- Approve Request Modal -->
@if (showApproveModal) {
  <div class="modal-overlay" (click)="closeApproveModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <h2 class="modal-title">Approve Request</h2>
      
      <div class="modal-info">
        <div class="info-row">
          <span class="info-label">Request ID:</span>
          <span class="info-value">R{{ selectedRequest?.id }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">{{ selectedRequest?.type === 'facility' ? 'Facility:' : 'Equipment:' }}</span>
          <span class="info-value">{{ selectedRequest?.name }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Requester:</span>
          <span class="info-value">{{ selectedRequest?.requester }}</span>
        </div>
      </div>

      <div class="modal-form-group">
        <label class="modal-label">Approval Notes (Optional)</label>
        <textarea 
          class="modal-textarea" 
          [(ngModel)]="approvalNotes"
          placeholder="Add any notes for the requester...">
        </textarea>
      </div>

      <div class="modal-checkbox">
        <input 
          type="checkbox" 
          id="approveNotify" 
          [(ngModel)]="sendNotification">
        <label for="approveNotify">Send notification to requester</label>
      </div>

      <div class="modal-actions">
        <button 
          class="modal-button modal-button-confirm" 
          (click)="confirmApproval()"
          [disabled]="actionLoading">
          {{ actionLoading ? 'Processing...' : 'Confirm' }}
        </button>
        <button 
          class="modal-button modal-button-cancel" 
          (click)="closeApproveModal()"
          [disabled]="actionLoading">
          Cancel
        </button>
      </div>
    </div>
  </div>
}

<!-- Decline Request Modal -->
@if (showDeclineModal) {
  <div class="modal-overlay" (click)="closeDeclineModal()">
    <div class="modal-container" (click)="$event.stopPropagation()">
      <h2 class="modal-title">Decline Request</h2>
      
      <div class="modal-info">
        <div class="info-row">
          <span class="info-label">Request ID:</span>
          <span class="info-value">R{{ selectedRequest?.id }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">{{ selectedRequest?.type === 'facility' ? 'Facility:' : 'Equipment:' }}</span>
          <span class="info-value">{{ selectedRequest?.name }}</span>
        </div>
        <div class="info-row">
          <span class="info-label">Requester:</span>
          <span class="info-value">{{ selectedRequest?.requester }}</span>
        </div>
      </div>

      <div class="modal-form-group">
        <label class="modal-label">Reason for Decline (Required)</label>
        <textarea 
          class="modal-textarea" 
          [(ngModel)]="declineReason"
          placeholder="Please provide a reason for declining this request...">
        </textarea>
      </div>

      <div class="modal-checkbox">
        <input 
          type="checkbox" 
          id="declineNotify" 
          [(ngModel)]="sendNotification">
        <label for="declineNotify">Send notification to requester</label>
      </div>

      <div class="modal-actions">
        <button 
          class="modal-button modal-button-confirm" 
          (click)="confirmDecline()"
          [disabled]="!declineReason.trim() || actionLoading">
          {{ actionLoading ? 'Processing...' : 'Confirm' }}
        </button>
        <button 
          class="modal-button modal-button-cancel" 
          (click)="closeDeclineModal()"
          [disabled]="actionLoading">
          Cancel
        </button>
      </div>
    </div>
  </div>
}
